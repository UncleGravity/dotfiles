# 
# ████████╗███╗   ███╗██╗   ██╗██╗  ██╗
# ╚══██╔══╝████╗ ████║██║   ██║╚██╗██╔╝
#    ██║   ██╔████╔██║██║   ██║ ╚███╔╝ 
#    ██║   ██║╚██╔╝██║██║   ██║ ██╔██╗ 
#    ██║   ██║ ╚═╝ ██║╚██████╔╝██╔╝ ██╗
#    ╚═╝   ╚═╝     ╚═╝ ╚═════╝ ╚═╝  ╚═╝       

# -----------------------------------------
# Terminal Compatibility
# -----------------------------------------
# Sets TMUX to be 24-bit color, provided the terminal supports it
set -g default-terminal "tmux-256color"
# set -g default-terminal "xterm-kitty"
set-option -ga terminal-overrides ",xterm-256color:Tc,tmux-256color:Tc"

# Yazi compatibility
set -g allow-passthrough on 
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

set -ga terminal-features "*:hyperlinks" # Enable hyperlinks in tmux
set -s set-clipboard on # Enable clipboard

# -----------------------------------------
# PREFIX
# -----------------------------------------
# Set Prefix to Ctrl-s
set -g prefix C-b
bind C-b send-prefix

# -----------------------------------------
# PLUGINS
# -----------------------------------------

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -sg escape-time 25 # Workaround. Prevent appearing 0;10;1c when tmux start
set -g @plugin 'christoomey/vim-tmux-navigator'
# set -g @plugin 'dreamsofcode-io/catppuccin-tmux' # Fork of catppuccin/tmux

# -----------------------------------------
# CATPPUCCIN THEME
# -----------------------------------------

# move status bar to the top
set-option -g status-position top

# set -g @plugin 'catppuccin/tmux'
# set -g @catppuccin_flavour 'mocha' # latte,frappe, macchiato or mocha
# set -g @catppuccin_status_modules_right "application session"
# set -g @catppuccin_status_modules_left ""
# set -g @catppuccin_window_status_enable "yes"

# set -g @catppuccin_window_left_separator ""
# set -g @catppuccin_window_right_separator " "
# set -g @catppuccin_window_middle_separator " | "
# set -g @catppuccin_window_number_position "right"
# set -g @catppuccin_window_default_fill "none"
# set -g @catppuccin_window_current_fill "all"
# set -g @catppuccin_status_left_separator  " "
# set -g @catppuccin_status_right_separator ""
# set -g @catppuccin_status_fill "icon"
# set -g @catppuccin_status_connect_separator "no"

# set -g @catppuccin_window_default_text "#(~/.config/tmux/utils.sh --path '#{pane_current_path}' '#{pane_current_command}' '#{pane_tty}')"
# set -g @catppuccin_window_current_text "#(~/.config/tmux/utils.sh --path '#{pane_current_path}' '#{pane_current_command}' '#{pane_tty}')"
# set -g @catppuccin_application_text "#(~/.config/tmux/utils.sh --program '#{pane_current_path}' '#{pane_current_command}' '#{pane_tty}')"
# # set -g @catppuccin_host_text "#{user}@#{host}"

# set -g @catppuccin_session_icon "\uebc8" # tmux icon
# set -g @catppuccin_application_icon "\uf4b5" # cmd line icon

# set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
# set -g @plugin 'wfxr/tmux-power'
# set -g @tmux_power_theme 'everforest'
# set -g @tmux_power_theme 'default'
# set -g @tmux_power_prefix_highlight_pos 'L'

set -g @plugin 'fabioluciano/tmux-tokyo-night'
set -g @theme_session_icon "\uf11c " #  
# set -g @theme_session_icon "\uebc8" #  
set -g @theme_variation 'night'
# set -g @theme_plugins 'datetime'
set -g @theme_disable_plugins 1
set -g status-bg '#282828' # Match terminal theme (gruvbox)

# set -g @plugin 'erikw/tmux-powerline'I

# -----------------------------------------
# KEY BINDINGS
# -----------------------------------------

# Enable mouse control (clickable windows, panes, res``izable panes)
set -g mouse on

# Enable vi mode
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection # visual mode
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel # yank

# split panes using | - (and open new panes in the same directory)
unbind %
unbind '"'
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Create new window with C-b n
unbind n
bind n new-window

# Switch widnows with H and L
bind -n M-H previous-window
bind -n M-L next-window

# Swap Windows
# Better to handle with Prefix+< default behavior (dropdown)
# bind-key -r "<" swap-window -d -t -1
# bind-key -r ">" swap-window -d -t +1

# # Maximize / Minimize current pane
bind -r m resize-pane -Z

# Start windows and panes at 1 not 0 (breaks twm)
# set-option -g base-index 1
# set-option -g pane-base-index 1
# set-window-option -g pane-base-index 1
# set-option -g renumber-windows on

# Resize panes with prefix C-hjkl
bind -r C-h resize-pane -L 5
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5
bind -r C-l resize-pane -R 5

# Kill current session with prefix+k
bind k confirm-before -p "Kill current session? (y/n)" kill-session
bind-key x kill-pane # skip "kill-pane 1? (y/n)" prompt
# set -g detach-on-destroy off  # don't exit from tmux when closing a session

# Prefix + N and P to cycle between sessions
bind P switch-client -p
bind N switch-client -n
# Prefix L for last session

# bind-key "K" display-popup -E -w 40% "sesh connect \"$(
#   (
#     sesh list -ic;
#     sesh list -it;
#     sesh list -iz | head -n 5;
#     fd -t d -H '^.git$' ~/Documents $(test -d /media/psf/Home/Documents && echo /media/psf/Home/Documents) -x echo $'\033[38;2;241;80;47m \033[0m'{//} | sed -E "s|$HOME|~|" 
#   ) | gum filter --limit 1 --placeholder 'Pick a sesh' --height 50 --prompt='⚡'
# )\""

bind-key "K" run-shell "sesh connect \"$(
   (
    sesh list -ic;
    sesh list -it;
    sesh list -jz | jq -r '.[] | select(.Score >= 1) | \"\\u001b[36m \\u001b[0m\" + .Name';
    fd -t d -H '^.git$' ~/Documents \$(test -d /media/psf/Home/Documents && echo /media/psf/Home/Documents) -x sh -c 'echo -e \"\\033[38;2;241;80;47m \\033[0m$(echo \"{//}\" | sed -E \"s|$HOME|~|\")\"'
  ) | fzf-tmux -p 55%,60% --ansi --border-label ' sesh ' --prompt '⚡  ' | sed 's/^..//'
)\""

# -----------------------------------------
# MISC
# -----------------------------------------

# Set status update interval to 1 second
set -g status-interval 1

# Don't exit from tmux when closing a session
set -g detach-on-destroy off

# # don't exit copy mode after dragging with mouse
# unbind -T copy-mode-vi MouseDragEnd1Pane 

# # don't rename windows automatically
# set-option -g allow-rename off

# -----------------------------------------
# TMUX Plugin Manager
# -----------------------------------------

# "Install" (clone) the TMUX plugin manager if it doesn't exist
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
